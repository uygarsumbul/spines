cd ~/spines/repo
code{1}{1}                               = '9_upsampled_reconstruction_stitched_connected_labelled.eswc';
code{2}{1}                               = '18_upsampled_reconstruction_stitched_connected_labelled.eswc';
code{3}{1}                               = '19_unsampled_reconstruction_stitched_connected_labelled.eswc';
code{4}{1}                               = '20_upsampled_reconstruction_stitched_connected_labelled.eswc';
code{5}{1}                               = '21_upsampled_reconstruction_stitched_connected_labelled.eswc';
code{6}{1}                               = '22_upsampled_reconstruction_stitched_connected_labelled.eswc';
code{7}{1}                               = '23_upsampled_reconstruction_stitched_connected_labelled.eswc';
code{8}{1}                               = '24_upsampled_reconstruction_stitched_connected_labelled.eswc';
code{9}{1}                               = '25_upsampled_reconstruction_stitched_connected_labelled.eswc';
directory                                = '/home/uygar/spines/data/upsampledFinalReconstructions/';
options.resolution                       = [0.12 0.12 0.1];
allTrees                                 = readDataset_spines(code,directory,options);
[counts,centers, allCounts, allPairwiseDistances] = pairwiseDistanceDistribution_inhOnSpine(allTrees, 18, 80, 0.5);
figure;plot(centers, counts/sum(counts)/0.5,'LineWidth',2);
hold;for tr=1:numel(allCounts); plot(centers, allCounts{tr}/sum(allCounts{tr})/0.5,'LineWidth',2,'Color',[0.7 0.7 0.7]); end;
plot(centers, counts/sum(counts)/0.5);
figure;hold;for tr=1:numel(allCounts); plot(centers, allCounts{tr}/sum(allCounts{tr})/0.5,'Color',[0.7 0.7 0.7]); end; plot(centers, counts/sum(counts)/0.5,'LineWidth',2); 
allTreesS                                 = readDataset_spines_shuffleInhOnSpines(code,directory,options);
[countsS,centersS, allCountsS, allPairwiseDistancesS] = pairwiseDistanceDistribution_inhOnSpine(allTreesS, 18, 80, 0.5);
plot(centersS, countsS/sum(countsS)/0.5,'LineWidth',2,'Color','r');
figure;hold;for tr=1:numel(allCountsS); plot(centersS, allCountsS{tr}/sum(allCountsS{tr})/0.5,'Color',[0.7 0.7 0.7]); end; plot(centersS, countsS/sum(countsS)/0.5,'LineWidth',2,'Color','r');
figure(1);ylim([0 0.21]); figure(2);ylim([0 0.21]);
set(gca,'FontSize',16);xlabel('pairwise distance between IS on spines (\mu)', 'FontSize', 16); ylabel('frequency', 'FontSize', 16); set(gcf, 'Color','w')
saveas(gcf, '/home/uygar/spines/results/pairwiseDistancePDFforISOnSpines.jpg');
close 
set(gca,'FontSize',16);xlabel('pairwise distance between IS on spines (\mu)', 'FontSize', 16); ylabel('frequency', 'FontSize', 16); set(gcf, 'Color','w'); title('Shuffled IS','FontSize',16);
saveas(gcf, '/home/uygar/spines/results/pairwiseDistancePDFforShuffledISOnSpines.jpg');


allOneSidedP = []; allSampleSTD = []; all5quantile = []; all95quantile = [];
cd ~/spines/repo
[allIonECounts allIonlyCounts totalIonECount totalIonlyCount] = returnAllRatios_inhOnSpines(allTrees, 1);
allIonECounts = cell2mat(allIonECounts);
allIonlyCounts      = cell2mat(allIonlyCounts);
allIonERatios      = allIonECounts ./ (allIonlyCounts+allIonECounts);
iFr              = totalIonECount / (totalIonlyCount+totalIonECount);
sampleSTD            = std(allIonERatios);
endPoints            = cumsum(allIonECounts);
allShufflesSTD       = zeros(1, 1000);
for tt = 1:numel(allShufflesSTD)
  shuffledIonE = randperm(totalIonlyCount+totalIonECount, round(iFr*(totalIonlyCount+totalIonECount)));
  prevCount = 0;
  for kk = 1:numel(allIonERatios)
    thisCount         = nnz(endPoints(kk)>=shuffledIonE);
    shuffledRatio(kk) = (thisCount-prevCount) / (allIonlyCounts(kk)+allIonECounts(kk));
    prevCount         = thisCount;
  end
  allShufflesSTD(tt)  = std(shuffledRatio);
end
oneSided_p = nnz(sampleSTD<allShufflesSTD)/numel(allShufflesSTD); allOneSidedP(end+1)=oneSided_p; allSampleSTD(end+1)=sampleSTD;
all5quantile(end+1)=quantile(allShufflesSTD,0.05); all95quantile(end+1)=quantile(allShufflesSTD,0.95);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
temp2 = zeros(10, numel(pairAndSomaDistances));
for kk=0:9
  [~,~,~, pairAndSomaDistances] = pairwiseDistanceDistribution_scratch2(allTrees, 'spine', -1:1, 0.1*kk+eps, 'apical', 'terminal'); for mm=1:numel(pairAndSomaDistances); tt(mm)=size(pairAndSomaDistances{mm},1); end;
  [~,~,~, pairAndSomaDistances] = pairwiseDistanceDistribution_scratch2(allTrees, 'spine', -1:1, 0.1*kk+eps, 'apical', 'intermediate'); for mm=1:numel(pairAndSomaDistances); ti(mm)=size(pairAndSomaDistances{mm},1); end;
  temp2(kk+1,:)=tt./ti;
end



[allPairwiseDistances, allXYZofNodesOfInterest, allSomaDistancesOfNodesOfInterest, pairAndSomaDistances] = pairwiseDistanceDistribution_scratch2(trees, 'spine', -1:1, 0.8, 'apical', 'intermediateOrTerminal');

h = fspecial('gaussian', [19 1], 3);


for kk = 1:numel(trees)
  pD = []; sD = [];
  for mm = 1:numel(trees{kk})
    pD = [pD; allPairwiseDistances{kk}{mm}]; sD = [sD; (allSomaDistancesOfNodesOfInterest{kk}{mm}(1:end-1)+allSomaDistancesOfNodesOfInterest{kk}{mm}(2:end))/2];
  end
  aPD{kk} = pD; aSD{kk} = sD;
  tmp = aSD{kk}/400; tmp = tmp - 0.5;

  tpd = aPD{kk}; tpd = tpd-min(tpd); tpd = tpd/max(tpd);
  tsd = aSD{kk}; tsd = tsd-min(tsd); tsd = tsd/max(tsd);
  ks = tpd+i*tsd;
  [ksv, ia, ic] = unique(ks(:));
  tmp=tmp(ia); aPD{kk}=aPD{kk}(ia); aSD{kk}=aSD{kk}(ia);
  ext = size(ksv,1);
  [maxks, idx] = max(abs(ksv));
  dk = 0.001; % 0.005; % abs(ksv(idx)) - abs(ksv(idx-1));
  vec1 = linspace(-dk,1+dk,200);
  vec2 = linspace(-dk,1+dk,200);
  [xx, yy] = meshgrid(vec1,vec2);
  rectPoints = xx(:)+i*yy(:);
  tessDist = sqrt(pdist2(real(rectPoints), real(ksv)).^2 + pdist2(imag(rectPoints), imag(ksv)).^2);
  rectPoints(any(tessDist<dk,2)) = [];
  ksv2 = [ksv' rectPoints'];
  dens = voronoidens(real(ksv2), imag(ksv2));
  dens = dens(1:ext);
  interpolated(:,kk) = conv(pureGridder1d(tmp, dens'.*aPD{kk}/sum(aPD{kk}), 100), h, 'same');
end
standardizedSD = 0:10:390;


h = fspecial('gaussian', [13 1], 2);
for kk = 1:numel(trees)
  pD = []; sD = [];
  for mm = 1:numel(trees{kk})
    pD = [pD; allPairwiseDistances{kk}{mm}]; sD = [sD; (allSomaDistancesOfNodesOfInterest{kk}{mm}(1:end-1)+allSomaDistancesOfNodesOfInterest{kk}{mm}(2:end))/2];
  end
  aRD{kk} = 1./(pD+eps); aSD{kk} = sD;
  tmp = aSD{kk}/400; tmp = tmp - 0.5;
  trd = aRD{kk}; trd = trd-min(trd); trd = trd/max(trd);
  tsd = aSD{kk}; tsd = tsd-min(tsd); tsd = tsd/max(tsd);
  ks = trd+i*tsd;
  [ksv, ia, ic] = unique(ks(:));
  tmp=tmp(ia); aRD{kk}=aRD{kk}(ia); aSD{kk}=aSD{kk}(ia);
  ext = size(ksv,1);
  [maxks, idx] = max(abs(ksv));
  dk = 0.001; % 0.005; % abs(ksv(idx)) - abs(ksv(idx-1));
  vec1 = linspace(-dk,1+dk,200);
  vec2 = linspace(-dk,1+dk,200);
  [xx, yy] = meshgrid(vec1,vec2);
  rectPoints = xx(:)+i*yy(:);
  tessDist = sqrt(pdist2(real(rectPoints), real(ksv)).^2 + pdist2(imag(rectPoints), imag(ksv)).^2);
  rectPoints(any(tessDist<dk,2)) = [];
  ksv2 = [ksv' rectPoints'];
  dens = voronoidens(real(ksv2), imag(ksv2));
  dens = dens(1:ext);
  interpolated(:,kk) = conv(pureGridder1d(tmp, dens'.*aRD{kk}/sum(aRD{kk}), 100), h, 'same');
end



kk=1;for tt=5:280; temp(tt-4)=mean(aPD{kk}(aSD{kk}<tt+5 & aSD{kk}>=tt-5)); end;


  ks = aPD{kk}+i*aSD{kk};
  ksv = ks(:);
  ext = size(ksv,1);
  [maxks, idx] = max(abs(ksv));
  dk = abs(ksv(idx)) - abs(ksv(idx-1));
  circle = (maxks + dk)*exp(i*2*pi*(0:0.001:(1-0.001)));
  ksv2 = [ksv' circle];
  dens = voronoidens(real(ksv2), imag(ksv2));
  dens = dens(1:ext);
